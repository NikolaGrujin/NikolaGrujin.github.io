<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Radioport</title>
        <link rel="stylesheet" href="style.css">
        <link rel="manifest" href="manifest.json">
    </head>
    <body>
        <input type="file" id="musicInput" accept=".mp3,audio/mpeg" multiple/>
        <button id="shuffle">Shuffle</button>
        <button id="play">Play</button>
        <button id="previous">Previous</button>
        <button id="next">Next</button>
        <button id="pause">Pause</button>
        <button id="clear">Clear</button>
        <h3>Playlist:</h3>
        <ol id="playlist">
        </ol>
        <script type="text/javascript">
            //Service worker
            if("serviceWorker" in navigator)
            {
                navigator.serviceWorker.register("service-worker.js").then(() => {
                    console.log("Service worker registered!");
                }).catch((error) => {
                    window.alert("Error registering service worker!\nError: " + error);
                });
            }
            
            //UI controls
            const musicInput = document.getElementById("musicInput");
            const shufButton = document.getElementById("shuffle");
            const playButton = document.getElementById("play");
            const prevButton = document.getElementById("previous");
            const nextButton = document.getElementById("next");
            const pauseButton = document.getElementById("pause");
            const clearButton = document.getElementById("clear");

            //Playlist list element, playlist, last 20 played songs, and song list
            const playlistList = document.getElementById("playlist");
            let songlist = {};
            let playlist = [];
            let last_played = [];
            let current_song = 0;
            
            //Audio element
            const audioPlayer = new Audio();

            //Load audio files, and sort alphabetically into playlist
            function loadMusic()
            {
                if(musicInput.files.length > 0)
                {
                    for(const song of musicInput.files)
                    {
                        songlist[song.name] = URL.createObjectURL(song);
                        playlist.push(song.name);
                    }

                    playlist.sort();

                    for(let song of playlist)
                    {
                        const listEntry = document.createElement("li");
                        const entryText = document.createTextNode(song);
                        listEntry.appendChild(entryText);
                        playlistList.appendChild(listEntry);
                    }

                    audioPlayer.src = songlist[playlist[current_song]];
                }
            }

            //Shuffle playlist
            function shuffle()
            {

            }

            //Play
            function play()
            {
                if(audioPlayer.src != null)
                {
                    audioPlayer.play();
                }
            }

            //Previous song
            function previous()
            {
                pause();
                if(current_song > 0)
                {
                    current_song--;
                }
                else
                {
                    current_song = playlist.length - 1;
                }
                audioPlayer.src = songlist[playlist[current_song]];
                play();
            }

            //Next song
            function next()
            {
                pause();
                if(current_song < playlist.length - 1)
                {
                    current_song++;
                }
                else
                {
                    current_song = 0;
                }
                audioPlayer.src = songlist[playlist[current_song]];
                play();
            }

            //Pause
            function pause()
            {
                if(audioPlayer.src != null)
                {
                    audioPlayer.pause();
                }
            }

            //Clear playlist
            function clear()
            {
                audioPlayer.pause();
                audioPlayer.src = null;
                for(let song in songlist)
                {
                    URL.revokeObjectURL(songlist[song]);
                    delete songlist[song];
                }
                playlist = [];
                let entries = playlistList.querySelectorAll("li");
                for(let entry of entries)
                {
                    playlistList.removeChild(entry);
                }
            }

            //Attaching event listeners to controls
            musicInput.addEventListener("change", loadMusic);
            shufButton.addEventListener("click", shuffle);
            playButton.addEventListener("click", play);
            prevButton.addEventListener("click", previous);
            nextButton.addEventListener("click", next);
            pauseButton.addEventListener("click", pause);
            clearButton.addEventListener("click", clear);
        </script>
    </body>
</html>
